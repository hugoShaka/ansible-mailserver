---
- name: Copy SQL database schema to server
  copy:
    src: schema.sql
    dest: /tmp

- name: Set up SQL schema of mailserver database
  postgresql_db:
    name: mailserver
    state: restore
    target: /tmp/schema.sql
  become: true
  become_user: postgres

- name: Give pgadmin rights on the mail db
  postgresql_privs:
    database: mailserver
    type: table
    objs: "{{ item }}"
    roles: pgadmin
    privs: SELECT,INSERT,UPDATE,DELETE
  with_items:
    - virtual_domains
    - virtual_aliases
    - virtual_users
  become: true
  become_user: postgres

- name: Give mail user rights on the mail db
  postgresql_privs:
    database: mailserver
    type: table
    objs: "{{ item }}"
    roles: mail
    privs: SELECT
  with_items:
    - virtual_domains
    - virtual_aliases
    - virtual_users
  become: true
  become_user: postgres
