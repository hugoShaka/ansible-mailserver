---
- name: "Grant user postfix read permission on the private key"
  acl:
    path: "{{ ispmail_certificate_keyfile }}"
    entity: postfix
    etype: user
    permissions: r
    state: present

- name: define Postfix sender login mapping
  copy: src=pgsql-sender-login-maps.cf dest=/etc/postfix/pgsql-sender-login-maps.cf
  notify: restart postfix

- name: define Postfix virtual mailbox domain mapping
  copy: src=pgsql-virtual-mailbox-domains.cf dest=/etc/postfix/pgsql-virtual-mailbox-domains.cf
  notify: restart postfix

- name: define Postfix virtual mailbox mapping
  copy: src=pgsql-virtual-mailbox-maps.cf dest=/etc/postfix/pgsql-virtual-mailbox-maps.cf
  notify: restart postfix

- name: define Postfix virtual alias mapping
  copy: src=pgsql-virtual-alias-maps.cf dest=/etc/postfix/pgsql-virtual-alias-maps.cf
  notify: restart postfix

- name: define Postfix email-to-email mapping (required for catchall domains)
  copy: src=pgsql-email2email.cf dest=/etc/postfix/pgsql-email2email.cf
  notify: restart postfix

- name: Restricting access to database mapping files that contain a password
  file: path=/etc/postfix/pgsql-{{item}}.cf mode=0644
  with_items:
  - virtual-mailbox-domains
  - virtual-mailbox-maps
  - virtual-alias-maps

- name: Copy main.cf conf file
  template:
    src: main.cf.j2
    dest: /etc/postfix/main.cf
  notify: restart postfix

- name: Copy master.cf conf file
  template:
    src: master.cf.j2
    dest: /etc/postfix/master.cf
  notify: restart postfix
