---
# Requires Ansible >= 2.2
- hosts: dev-test
  tasks:
    - name: Install packages
      apt:
        name:
          - python3-pip
          - vim
          - less
          - net-tools
        state: present
        cache_valid_time: 3600

    - name: Install python packages
      pip:
        name:
          - bpython
          - pytest
          - imapclient
        executable: pip3

    - name: Copy test suite
      copy:
        src: suite
        dest: /home/vagrant/

- hosts: dev-test
  roles:
    - mailtester-dnsmasq

- hosts: dev-mail
  tasks:
    - name: Use test resolver
      lineinfile:
        path: /etc/resolv.conf
        regexp: "^nameserver"
        line: "nameserver 10.0.0.50"

- hosts: db
  tasks:
    - name: Copy fixtures file
      copy:
        src: fixtures/mailserverdb.sql
        dest: /tmp

    - name: Import fixtures
      postgresql_db:
        name: mailserver
        state: restore
        target: /tmp/mailserverdb.sql
      become: true
      become_user: postgres

    - name: Restart postgres
      service:
        name: postgresql
        state: restarted

- hosts: mta
  tasks:
    - name: Restart postfix
      service:
        name: postfix
        state: restarted

- hosts: mda
  tasks:
    - name: Restart dovecot
      service:
        name: dovecot
        state: restarted
